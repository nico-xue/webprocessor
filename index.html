<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¸¸ä½¿ç”¨çš„Webè®¡ç®—å™¨</title>
    <!-- å¼•å…¥Reactå’ŒReact DOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- é…ç½®Tailwindä¸»é¢˜ -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#FF9500',
                        secondary: '#505050',
                        tertiary: '#D4D4D2',
                        background: '#FFFFFF',
                        darkBackground: '#1C1C1C',
                        darkSecondary: '#505050',
                        darkTertiary: '#D4D4D2',
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <!-- è‡ªå®šä¹‰å·¥å…·ç±» -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .calculator-btn {
                @apply rounded-full flex items-center justify-center font-semibold transition-all duration-150 active:opacity-80 active:scale-95;
            }
            .number-btn {
                @apply calculator-btn bg-gray-200 text-gray-900 hover:bg-gray-300 dark:bg-darkSecondary dark:text-white dark:hover:bg-opacity-80;
            }
            .operator-btn {
                @apply calculator-btn bg-primary text-white hover:bg-opacity-90;
            }
            .function-btn {
                @apply calculator-btn bg-gray-300 text-gray-900 hover:bg-gray-400 dark:bg-darkTertiary dark:text-gray-900 dark:hover:bg-opacity-80;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div id="root" class="w-full max-w-md mx-auto p-4 md:p-8"></div>

    <script type="text/babel">
        // ä½¿ç”¨React 18çš„createRoot API
        const { useState, useEffect, useRef } = React;

        // å®‰å…¨çš„è¡¨è¾¾å¼è§£æå™¨ï¼Œä¸ä½¿ç”¨eval()
        function evaluateExpression(expression) {
            try {
                // ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
                const cleanExpression = expression.replace(/\s+/g, '');
                
                // æ£€æŸ¥è¡¨è¾¾å¼æ˜¯å¦åŒ…å«éæ³•å­—ç¬¦
                if (!/^[\d+\-Ã—Ã·.%\(\)]+$/.test(cleanExpression)) {
                    throw new Error('è¡¨è¾¾å¼åŒ…å«éæ³•å­—ç¬¦');
                }
                
                // å°†ä¹˜é™¤ç¬¦å·è½¬æ¢ä¸ºJavaScriptè¿ç®—ç¬¦
                const jsExpression = cleanExpression
                    .replace(/Ã—/g, '*')
                    .replace(/Ã·/g, '/')
                    .replace(/%/g, '*0.01');
                
                // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Functionæ„é€ å‡½æ•°ä½œä¸ºæ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ
                // æ³¨æ„ï¼šè¿™ä»ç„¶æœ‰æ½œåœ¨çš„å®‰å…¨é£é™©ï¼Œä½†æ¯”evalè¦å¥½ä¸€äº›
                // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”è¯¥è€ƒè™‘ä½¿ç”¨æ›´å¤æ‚çš„è§£æå™¨åº“
                const result = new Function(`return ${jsExpression}`)();
                
                // æ£€æŸ¥ç»“æœæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
                if (isNaN(result) || !isFinite(result)) {
                    throw new Error('è®¡ç®—ç»“æœæ— æ•ˆ');
                }
                
                return result;
            } catch (error) {
                throw error;
            }
        }

        // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºï¼Œå¤„ç†å¤§æ•°å’Œå°æ•°
        function formatNumber(num) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ•´æ•°
            if (Number.isInteger(num)) {
                // å¤„ç†å¤§æ•°ï¼Œä½¿ç”¨toLocaleString
                if (Math.abs(num) > 999999999999) {
                    return num.toExponential(10);
                }
                return num.toLocaleString('zh-CN');
            }
            
            // å¤„ç†å°æ•°
            const decimalPlaces = 10;
            const rounded = Number(num.toFixed(decimalPlaces));
            
            // å¦‚æœå°æ•°éƒ¨åˆ†éƒ½æ˜¯0ï¼Œè½¬æ¢ä¸ºæ•´æ•°
            if (Number.isInteger(rounded)) {
                return rounded.toLocaleString('zh-CN');
            }
            
            // å¦åˆ™è¿”å›æ ¼å¼åŒ–çš„å°æ•°
            return rounded.toString();
        }

        // è®¡ç®—å™¨ç»„ä»¶
        const Calculator = () => {
            // çŠ¶æ€ç®¡ç†
            const [input, setInput] = useState('');
            const [result, setResult] = useState('0');
            const [history, setHistory] = useState([]);
            const [showError, setShowError] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            
            // é”®ç›˜äº‹ä»¶å¼•ç”¨
            const calculatorRef = useRef(null);

            // åˆ‡æ¢æš—è‰²æ¨¡å¼
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // é”®ç›˜äº‹ä»¶å¤„ç†
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // é˜²æ­¢é»˜è®¤è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯å¯¹äºEnteré”®
                    if (['Enter', 'Escape', 'Backspace', 'Delete', '+', '-', '*', '/', '.', '%'].includes(e.key)) {
                        e.preventDefault();
                    }
                    
                    // æ•°å­—é”®
                    if (/^[0-9]$/.test(e.key)) {
                        handleNumber(e.key);
                    }
                    // è¿ç®—ç¬¦é”®
                    else if (e.key === '+') handleOperator('+');
                    else if (e.key === '-' || e.key === '_') handleOperator('-');
                    else if (e.key === '*') handleOperator('Ã—');
                    else if (e.key === '/') handleOperator('Ã·');
                    else if (e.key === '%') handlePercentage();
                    // å°æ•°ç‚¹
                    else if (e.key === '.') handleDecimal();
                    // æ‹¬å·
                    else if (e.key === '(' || e.key === 'Shift' && e.key === '9') handleBracket('(');
                    else if (e.key === ')' || e.key === 'Shift' && e.key === '0') handleBracket(')');
                    // æ¸…é™¤
                    else if (e.key === 'Escape') handleClear();
                    else if (e.key === 'Delete') handleAllClear();
                    else if (e.key === 'Backspace') handleBackspace();
                    // ç­‰äº
                    else if (e.key === 'Enter' || e.key === '=') handleCalculate();
                };

                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [input]);

            // å¤„ç†æ•°å­—è¾“å…¥
            const handleNumber = (num) => {
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                if (showError) {
                    setShowError(false);
                    setInput(num);
                } else {
                    // é¿å…å‰å¯¼é›¶
                    if (input === '0' && num !== '0') {
                        setInput(num);
                    } else {
                        setInput(prev => prev + num);
                    }
                }
            };

            // å¤„ç†å°æ•°ç‚¹
            const handleDecimal = () => {
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                if (showError) {
                    setShowError(false);
                    setInput('0.');
                    return;
                }
                
                // æ£€æŸ¥å½“å‰è¡¨è¾¾å¼çš„æœ€åä¸€ä¸ªæ•°å­—éƒ¨åˆ†æ˜¯å¦å·²ç»åŒ…å«å°æ•°ç‚¹
                const parts = input.split(/[+\-Ã—Ã·]/);
                const lastPart = parts[parts.length - 1];
                
                if (!lastPart.includes('.')) {
                    // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ·»åŠ å‰å¯¼é›¶
                    if (input === '' || ['+', '-', 'Ã—', 'Ã·'].includes(input.slice(-1))) {
                        setInput(prev => prev + '0.');
                    } else {
                        setInput(prev => prev + '.');
                    }
                }
            };

            // å¤„ç†è¿ç®—ç¬¦
            const handleOperator = (operator) => {
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                if (showError) {
                    setShowError(false);
                    return;
                }
                
                // å¦‚æœè¾“å…¥ä¸ºç©ºä¸”è¿ç®—ç¬¦ä¸ºè´Ÿå·ï¼Œå…è®¸è¾“å…¥
                if (input === '' && operator === '-') {
                    setInput('-');
                    return;
                }
                
                // é¿å…è¿ç»­çš„è¿ç®—ç¬¦
                const lastChar = input.slice(-1);
                if (['+', '-', 'Ã—', 'Ã·'].includes(lastChar)) {
                    setInput(prev => prev.slice(0, -1) + operator);
                } else {
                    setInput(prev => prev + operator);
                }
            };

            // å¤„ç†æ‹¬å·
            const handleBracket = (bracket) => {
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                if (showError) {
                    setShowError(false);
                    setInput(bracket);
                    return;
                }
                
                setInput(prev => prev + bracket);
            };

            // å¤„ç†ç™¾åˆ†æ¯”
            const handlePercentage = () => {
                // æ¸…é™¤é”™è¯¯çŠ¶æ€
                if (showError) {
                    setShowError(false);
                    setInput('0%');
                    return;
                }
                
                // æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©º
                if (input === '') {
                    setInput('0%');
                    return;
                }
                
                setInput(prev => prev + '%');
            };

            // è®¡ç®—ç»“æœ
            const handleCalculate = () => {
                try {
                    // æ¸…é™¤é”™è¯¯çŠ¶æ€
                    setShowError(false);
                    
                    // æ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©º
                    if (input === '') return;
                    
                    // è®¡ç®—ç»“æœ
                    const calculationResult = evaluateExpression(input);
                    const formattedResult = formatNumber(calculationResult);
                    
                    // æ›´æ–°ç»“æœæ˜¾ç¤º
                    setResult(formattedResult);
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    const historyItem = {
                        expression: input,
                        result: formattedResult,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    
                    setHistory(prev => [historyItem, ...prev].slice(0, 10)); // åªä¿ç•™æœ€è¿‘10æ¡
                    
                    // è®¾ç½®è¾“å…¥ä¸ºç»“æœï¼Œæ–¹ä¾¿ç»§ç»­è®¡ç®—
                    setInput(formattedResult);
                } catch (error) {
                    setShowError(true);
                    setResult('é”™è¯¯: ' + error.message);
                }
            };

            // æ¸…é™¤å½“å‰è¾“å…¥
            const handleClear = () => {
                setShowError(false);
                setInput('');
            };

            // æ¸…é™¤æ‰€æœ‰å†…å®¹
            const handleAllClear = () => {
                setShowError(false);
                setInput('');
                setResult('0');
            };

            // é€€æ ¼
            const handleBackspace = () => {
                if (showError) {
                    setShowError(false);
                    setInput('');
                } else {
                    setInput(prev => prev.slice(0, -1));
                }
            };

            // ä»å†å²è®°å½•æ¢å¤è¡¨è¾¾å¼
            const restoreFromHistory = (expression) => {
                setShowError(false);
                setInput(expression);
                setShowHistory(false);
            };

            // æŒ‰é’®ç½‘æ ¼å¸ƒå±€
            const buttons = [
                { label: 'AC', class: 'function-btn', onClick: handleAllClear },
                { label: 'âŒ«', class: 'function-btn', onClick: handleBackspace },
                { label: '%', class: 'function-btn', onClick: handlePercentage },
                { label: 'Ã·', class: 'operator-btn', onClick: () => handleOperator('Ã·') },
                
                { label: '7', class: 'number-btn', onClick: () => handleNumber('7') },
                { label: '8', class: 'number-btn', onClick: () => handleNumber('8') },
                { label: '9', class: 'number-btn', onClick: () => handleNumber('9') },
                { label: 'Ã—', class: 'operator-btn', onClick: () => handleOperator('Ã—') },
                
                { label: '4', class: 'number-btn', onClick: () => handleNumber('4') },
                { label: '5', class: 'number-btn', onClick: () => handleNumber('5') },
                { label: '6', class: 'number-btn', onClick: () => handleNumber('6') },
                { label: '-', class: 'operator-btn', onClick: () => handleOperator('-') },
                
                { label: '1', class: 'number-btn', onClick: () => handleNumber('1') },
                { label: '2', class: 'number-btn', onClick: () => handleNumber('2') },
                { label: '3', class: 'number-btn', onClick: () => handleNumber('3') },
                { label: '+', class: 'operator-btn', onClick: () => handleOperator('+') },
                
                { label: '(', class: 'number-btn', onClick: () => handleBracket('(') },
                { label: '0', class: 'number-btn col-span-1', onClick: () => handleNumber('0') },
                { label: '.', class: 'number-btn', onClick: handleDecimal },
                { label: ')', class: 'number-btn', onClick: () => handleBracket(')') },
                
                { label: '=', class: 'operator-btn col-span-4', onClick: handleCalculate }
            ];

            return (
                <div 
                    ref={calculatorRef}
                    className="flex flex-col h-full min-h-[80vh] bg-white dark:bg-darkBackground rounded-3xl shadow-xl overflow-hidden border border-gray-200 dark:border-gray-700"
                >
                    {/* æ ‡é¢˜æ å’Œæ¨¡å¼åˆ‡æ¢ */}
                    <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                        <h1 className="text-xl font-bold text-gray-800 dark:text-white">è®¡ç®—å™¨</h1>
                        <div className="flex gap-3">
                            <button 
                                onClick={() => setShowHistory(!showHistory)}
                                className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                            >
                                {showHistory ? 'éšè—' : 'å†å²'}
                            </button>
                            <button 
                                onClick={() => setDarkMode(!darkMode)}
                                className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                            >
                                {darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                            </button>
                        </div>
                    </div>

                    {/* å†å²è®°å½•é¢æ¿ */}
                    {showHistory && (
                        <div className="overflow-y-auto max-h-60 p-4 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                            {history.length === 0 ? (
                                <p className="text-gray-500 dark:text-gray-400 text-center">æš‚æ— å†å²è®°å½•</p>
                            ) : (
                                <div className="space-y-3">
                                    {history.map((item, index) => (
                                        <div 
                                            key={index} 
                                            className="p-2 rounded-lg bg-white dark:bg-gray-700 shadow-sm hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer"
                                            onClick={() => restoreFromHistory(item.expression)}
                                        >
                                            <div className="text-sm text-gray-500 dark:text-gray-400">{item.timestamp}</div>
                                            <div className="text-gray-800 dark:text-white">{item.expression}</div>
                                            <div className="text-right text-lg font-semibold text-primary">= {item.result}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* æ˜¾ç¤ºåŒºåŸŸ */}
                    <div className="flex-1 p-6 flex flex-col justify-end items-end">
                        {/* è¾“å…¥è¡¨è¾¾å¼æ˜¾ç¤º */}
                        <div className={`text-right text-xl md:text-2xl mb-2 text-gray-500 dark:text-gray-400 ${showError ? 'text-red-500' : ''}`}>
                            {input || '0'}
                        </div>
                        {/* ç»“æœæ˜¾ç¤º */}
                        <div className={`text-right text-4xl md:text-5xl font-bold text-gray-900 dark:text-white break-all word-break-all max-w-full ${showError ? 'text-red-500' : ''}`}>
                            {result}
                        </div>
                    </div>

                    {/* é”®ç›˜åŒºåŸŸ */}
                    <div className="p-4 grid grid-cols-4 gap-3">
                        {buttons.map((button, index) => (
                            <button
                                key={index}
                                className={`${button.class} ${button.class.includes('col-span') ? button.class : ''} 
                                    ${button.label === '0' ? 'col-span-1' : ''} 
                                    ${button.label === '=' ? 'col-span-4' : ''}`}
                                style={{
                                    height: button.label === '=' ? '60px' : '70px',
                                    fontSize: button.label === '=' ? '1.5rem' : '1.25rem'
                                }}
                                onClick={button.onClick}
                            >
                                {button.label}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // æ¸²æŸ“åº”ç”¨
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <React.StrictMode>
                <Calculator />
            </React.StrictMode>
        );
    </script>
</body>
</html>